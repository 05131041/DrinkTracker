<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>是有多愛喝 2026 </title>
    <!-- 需求 1: 引入 React, Tailwind CSS 與 Google Fonts -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }
        /* 需求 2: 夢幻低飽和色系漸層背景 */
        .dreamy-gradient {
            background: linear-gradient(135deg, #FDFBFD 0%, #F8F2FC 100%);
        }
        /* 需求 3: 玻璃擬態 (Glassmorphism) 面板 */
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        /* 需求 4: 手機版優化，防止縮放與布局適配 */
        input, select { font-size: 16px !important; }
        .calendar-cell { aspect-ratio: 1 / 1.5; min-height: 100px; position: relative; transition: all 0.2s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-pop { animation: fadeIn 0.3s ease-out forwards; }
        
        /* 需求 17 & 19: 日曆色階定義 (根據杯數變化) */
        .bg-cup-0 { background-color: rgba(255, 255, 255, 0.5); }
        .bg-cup-1 { background-color: #FDE2E4; } /* 淺粉 - 1杯 */
        .bg-cup-2 { background-color: #FAD2D6; } /* 中粉 - 2杯 */
        .bg-cup-3 { background-color: #F8BBD0; } /* 深粉 - 3杯以上 */
    </style>
</head>
<body class="dreamy-gradient min-h-screen text-[#94849A]">
    <div id="root"></div>

    <script type="module">
        // 需求 5: Firebase 初始化與雲端儲存設定
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // 修正點：移除 getAnalytics 引用，防止儲存時報錯導致空白頁
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : {
    		apiKey: "AIzaSyCFnYhdOMJNAxCnVoUDxDtAItKQjURd14w",
    		authDomain: "drinks-4eb2c.firebaseapp.com",
    		projectId: "drinks-4eb2c",
    		storageBucket: "drinks-4eb2c.firebasestorage.app",
    		messagingSenderId: "394916838880",
    		appId: "1:394916838880:web:ebe01d2df44542f0347f85",
    		measurementId: "G-2NMHKGMR9X"
	    };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'drink-tracker-2026';

        // 導出全域物件供 React 使用，確保函式可用
        window.FB = { db, auth, appId, doc, setDoc, onSnapshot, signInAnonymously, signInWithCustomToken, onAuthStateChanged };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // 需求 6: 珍珠奶茶 SVG 圖示
        const IconBoba = ({className}) => (
            <svg className={className} viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M18 14L22 52C22 55.3137 24.6863 58 28 58H36C39.3137 58 42 55.3137 42 52L46 14" stroke="currentColor" strokeWidth="3" strokeLinecap="round"/>
                <path d="M16 14H48" stroke="currentColor" strokeWidth="3" strokeLinecap="round"/>
                <circle cx="28" cy="48" r="2.5" fill="currentColor"/><circle cx="36" cy="46" r="2.5" fill="currentColor"/><circle cx="32" cy="52" r="2.5" fill="currentColor"/>
            </svg>
        );

        // 需求 7 & 18 & 20: 隨機可愛圖示清單 (星星、愛心、雲朵、閃爍、月亮)
        const CuteIcons = [
            (p) => <svg {...p} viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>,
            (p) => <svg {...p} viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>,
            (p) => <svg {...p} viewBox="0 0 24 24" fill="currentColor"><path d="M17.5 19c-3.037 0-5.5-2.463-5.5-5.5 0-3.037 2.463-5.5 5.5-5.5s5.5 2.463 5.5 5.5c0 3.037-2.463 5.5-5.5 5.5zm-11-2c-2.485 0-4.5-2.015-4.5-4.5s2.015-4.5 4.5-4.5 4.5 2.015 4.5 4.5-2.015 4.5-4.5 4.5z"/></svg>,
            (p) => <svg {...p} viewBox="0 0 24 24" fill="currentColor"><path d="M12 1L9 9l-8 3 8 3 3 8 3-8 8-3-8-3-3-8z"/></svg>,
            (p) => <svg {...p} viewBox="0 0 24 24" fill="currentColor"><path d="M12 3a9 9 0 1 0 9 9 9.75 9.75 0 0 0-.67-3.41l-.1-.27.27.1A7.5 7.5 0 0 1 12 3z"/></svg>
        ];

        function App() {
            const [user, setUser] = useState(null);
            const [currentMonth, setCurrentMonth] = useState(new Date(2026, 0, 1));
            const [records, setRecords] = useState({});
            const [selectedDate, setSelectedDate] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false);

            // 需求 5: Firebase 驗證邏輯
            useEffect(() => {
                const checkFB = setInterval(() => {
                    if (window.FB) {
                        clearInterval(checkFB);
                        const { auth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } = window.FB;
                        const initAuth = async () => {
                            try {
                                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                    await signInWithCustomToken(auth, __initial_auth_token);
                                } else { await signInAnonymously(auth); }
                            } catch(e) { console.error("Auth init error:", e); }
                        };
                        initAuth();
                        onAuthStateChanged(auth, setUser);
                    }
                }, 100);
            }, []);

            // 需求 5: 數據即時監聽
            useEffect(() => {
                if (!user || !window.FB) return;
                const { db, appId, doc, onSnapshot } = window.FB;
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'drinkData');
                const unsub = onSnapshot(docRef, (snap) => {
                    if (snap.exists()) setRecords(snap.data().records || {});
                }, (err) => console.error("Snapshot error:", err));
                return () => unsub();
            }, [user]);

            const saveToCloud = async (newRecords) => {
                if (!user || !window.FB) return;
                try {
                    const { db, appId, doc, setDoc } = window.FB;
                    const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'drinkData');
                    await setDoc(docRef, { records: newRecords });
                } catch (e) {
                    console.error("Save error:", e);
                }
            };

            const formatDate = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;

            // 需求 8 & 14 & 19: 智慧統計 (不計藍點延續杯數)
            const monthlyStats = useMemo(() => {
                const prefix = `${currentMonth.getFullYear()}-${String(currentMonth.getMonth() + 1).padStart(2, '0')}`;
                let cups = 0, cost = 0;
                const shops = {};
                Object.keys(records).forEach(d => {
                    if (d.startsWith(prefix)) {
                        (records[d] || []).forEach(r => {
                            if (!r.isContinued) cups++; 
                            cost += Number(r.price) || 0;
                            if (r.shopName) shops[r.shopName] = (shops[r.shopName] || 0) + 1;
                        });
                    }
                });
                return { cups, cost, fav: Object.entries(shops).sort((a,b) => b[1]-a[1])[0]?.[0] || '無' };
            }, [records, currentMonth]);

            // 需求 9: 明天繼續喝邏輯
            const handleSave = (dateStr, drinks) => {
                let updated = { ...records, [dateStr]: drinks };
                drinks.forEach(d => {
                    if (d.continueTomorrow) {
                        const next = new Date(dateStr);
                        next.setDate(next.getDate() + 1);
                        const nStr = formatDate(next);
                        if (next.getFullYear() === 2026) {
                            const nDrinks = updated[nStr] ? [...updated[nStr]] : [];
                            if (!nDrinks.some(x => x.shopName === d.shopName && x.itemName === d.itemName) && nDrinks.length < 3) {
                                nDrinks.push({ ...d, price: '', continueTomorrow: false, isContinued: true });
                                updated[nStr] = nDrinks;
                            }
                        }
                    }
                });
                setRecords(updated);
                saveToCloud(updated);
                setIsModalOpen(false);
            };

            const calendarDays = useMemo(() => {
                const year = currentMonth.getFullYear();
                const month = currentMonth.getMonth();
                const first = new Date(year, month, 1).getDay();
                const total = new Date(year, month + 1, 0).getDate();
                const days = [];
                for (let i = 0; i < first; i++) days.push(null);
                for (let d = 1; d <= total; d++) days.push(new Date(year, month, d));
                return days;
            }, [currentMonth]);

            return (
                <div className="max-w-md mx-auto min-h-screen p-2 pt-4 pb-20">
                    <div className="glass-panel rounded-[40px] shadow-2xl overflow-hidden border-4 border-white relative z-10">
                        
			{/* 需求 11: Header */}
                        <div className="p-6 flex flex-col items-center gap-4">
                            <h1 className="text-3xl font-black text-[#B2A4B8] flex items-center gap-2 italic tracking-tighter">
                                <IconBoba className="w-10 h-10 text-[#D1C4D4]" /> 多愛喝
                            </h1>
                            <div className="flex items-center gap-6 bg-white/50 px-6 py-2 rounded-full border border-white shadow-inner">
                                <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1))} className="font-bold">〈</button>
                                <div className="text-center min-w-[80px]">
                                    <span className="text-lg font-black text-[#94849A] block leading-none">2026</span>
                                    <span className="text-xs font-bold text-[#B2A4B8]">{currentMonth.getMonth() + 1}月</span>
                                </div>
                                <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1))} className="font-bold">〉</button>
                            </div>
                        </div>

                        {/* 需求 12: 統計卡片 */}
                        <div className="px-6 grid grid-cols-3 gap-2 mb-6">
                            <div className="bg-[#FDE2E4]/30 p-3 rounded-2xl text-center border border-white/50">
                                <p className="text-[8px] font-bold text-[#C19EA3] uppercase">本月杯數</p>
                                <p className="text-lg font-black text-[#E5A7AF]">{monthlyStats.cups}</p>
                            </div>
                            <div className="bg-[#F3E5F5]/30 p-3 rounded-2xl text-center border border-white/50">
                                <p className="text-[8px] font-bold text-[#A696AF]">本月花費</p>
                                <p className="text-lg font-black text-[#B39DDB]">${monthlyStats.cost}</p>
                            </div>
                            <div className="bg-[#FFF9E6]/30 p-3 rounded-2xl text-center border border-white/50">
                                <p className="text-[8px] font-bold text-[#B8B89F]">最常喝</p>
                                <p className="text-[10px] font-black text-[#A3A38E] truncate">{monthlyStats.fav}</p>
                            </div>
                        </div>

                        {/* 需求 10 & 17 & 19 & 20: 日曆區域 (包含色階、飲品名、藍點、隨機圖示) */}
                        <div className="px-3 pb-8 grid grid-cols-7 gap-1">
                            {['日', '一', '二', '三', '四', '五', '六'].map(d => <div key={d} className="text-center text-[10px] font-black text-[#D1C4D4] pb-2">{d}</div>)}
                            {calendarDays.map((d, i) => {
                                if (!d) return <div key={`empty-${i}`} className="h-24" />;
                                const s = formatDate(d);
                                const rs = records[s] || [];
                                
                                // 需求 19: 視覺化追蹤色階 (只計算實喝杯數)
                                const realCount = rs.filter(r => !r.isContinued).length;
                                const colorClass = realCount === 0 ? 'bg-cup-0' : (realCount === 1 ? 'bg-cup-1' : (realCount === 2 ? 'bg-cup-2' : 'bg-cup-3'));
                                
                                // 需求 20: 隨機可愛圖示 (根據日期分配)
                                const IconComp = CuteIcons[d.getDate() % CuteIcons.length];

                                return (
                                    <button 
                                        key={s} 
                                        onClick={() => { setSelectedDate(d); setIsModalOpen(true); }} 
                                        className={`calendar-cell rounded-xl border border-white/50 flex flex-col p-1 overflow-hidden shadow-sm hover:shadow-md ${colorClass}`}
                                    >
					{/* 日期與隨機圖示層 */}
                                        <div className="flex justify-between items-start w-full relative z-10">
                                            <span className="text-[9px] font-black text-[#94849A]">{d.getDate()}</span>
                                            {/* 需求 20: 隨機圖示展示 */}
                                            <div className="text-[#B2A4B8] opacity-30">
                                                {IconComp({className: "w-3 h-3"})}
                                            </div>
                                        </div>

                                        <div className="flex flex-col gap-0.5 mt-1 w-full overflow-hidden relative z-20">
                                            {/* 需求 19: 日曆格內顯示品名與藍點 */}
                                            {rs.map((r, idx) => (
                                                <div key={idx} className="flex items-center gap-0.5 bg-white/40 rounded-sm px-1 py-0.5 min-w-0">
                                                    {r.isContinued && <div className="w-1 h-1 rounded-full bg-blue-400 shrink-0 shadow-sm"></div>}
                                                    <span className="text-[7px] font-bold text-[#94849A] truncate leading-none">
                                                        {r.itemName || '飲品'}
                                                    </span>
                                                </div>
                                            ))}
                                        </div>
                                        {/* 隨機驚喜圖示 (第 13 點) */}
                                        {rs.length > 0 && (
                                            <div className="absolute bottom-0 right-0 opacity-10">
                                                {React.createElement(RandomIcons[d.getDate() % RandomIcons.length], { className: "w-6 h-6" })}
                                            </div>
                                        )}
                                    </button>
                                );
                            })}
                        </div>
                    </div>

                    {/* 需求 15: 沉浸式編輯彈窗 */}
                    {isModalOpen && selectedDate && (
                        <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/40 backdrop-blur-sm px-0">
                            <div className="bg-white w-full max-w-md h-[92vh] overflow-y-auto rounded-t-[40px] sm:rounded-[40px] p-6 pb-12 shadow-2xl animate-pop">
                                <div className="flex justify-between items-center mb-6">
                                    <div className="flex flex-col">
                                        <h2 className="text-2xl font-black text-[#B2A4B8] italic">{formatDate(selectedDate)}</h2>
                                        <span className="text-[10px] font-bold text-[#D1C4D4] tracking-widest uppercase">Recording Sweetness</span>
                                    </div>
                                    <button onClick={() => setIsModalOpen(false)} className="w-10 h-10 rounded-full bg-[#FAF7FD] flex items-center justify-center font-bold text-[#B2A4B8]">✕</button>
                                </div>
                                <DrinkEditor 
                                    initialDrinks={records[formatDate(selectedDate)] || []} 
                                    onSave={(drinks) => handleSave(formatDate(selectedDate), drinks)} 
                                />
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // 需求 16: 飲品編輯
        function DrinkEditor({ initialDrinks, onSave }) {
            const [drinks, setDrinks] = useState(initialDrinks);
            const add = () => drinks.length < 3 && setDrinks([...drinks, { shopName: '', itemName: '', price: '', size: '中杯', ice: '去冰', sugar: '微糖', continueTomorrow: false, isContinued: false }]);
            const up = (i, f, v) => { const n = [...drinks]; n[i][f] = v; setDrinks(n); };

            return (
                <div className="space-y-6">
                    {drinks.map((d, i) => (
                        <div key={i} className={`p-5 rounded-3xl border-2 relative ${d.isContinued ? 'bg-blue-50/40 border-blue-100' : 'bg-[#FDFBFD] border-[#F8F2FC]'}`}>
                            <button onClick={() => setDrinks(drinks.filter((_, idx) => idx !== i))} className="absolute top-4 right-4 text-[#D1C4D4]">✕</button>
                            
                            {d.isContinued && <div className="text-[8px] font-black text-blue-400 mb-2 uppercase italic tracking-tighter">Continued Drink (Not Counted)</div>}
                            
                            <div className="grid grid-cols-2 gap-3 mb-4">
                                <input className="p-3 bg-white rounded-xl border border-[#F8F2FC] font-bold text-sm outline-none" placeholder="店家" value={d.shopName} onChange={e => up(i, 'shopName', e.target.value)} />
                                <input className="p-3 bg-white rounded-xl border border-[#F8F2FC] font-bold text-sm outline-none" placeholder="品名" value={d.itemName} onChange={e => up(i, 'itemName', e.target.value)} />
                            </div>
                            
                            <div className="grid grid-cols-3 gap-2 mb-4">
                                <input type="number" className="p-3 bg-white rounded-xl border border-[#F8F2FC] text-sm font-bold outline-none" placeholder="NT$" value={d.price} onChange={e => up(i, 'price', e.target.value)} />
                                <div className="col-span-2 flex gap-1">
                                    {['中杯', '大杯'].map(s => (
                                        <button key={s} onClick={() => up(i, 'size', s)} className={`flex-1 text-[10px] font-bold rounded-xl border ${d.size === s ? 'bg-[#FDE2E4] border-[#FDE2E4] text-white' : 'bg-white border-[#F8F2FC]'}`}>{s}</button>
                                    ))}
                                </div>
                            </div>

                            <div className="mb-4">
                                <div className="flex flex-wrap gap-1.5">
                                    {['正常冰', '少冰', '微冰', '去冰', '常溫', '熱', '無法調整'].map(l => (
                                        <button key={l} onClick={() => up(i, 'ice', l)} className={`px-3 py-1.5 text-[9px] font-bold rounded-xl border ${d.ice === l ? 'bg-[#E2F0FB] text-[#7895B2] border-[#E2F0FB]' : 'bg-white border-[#F8F2FC]'}`}>{l}</button>
                                    ))}
                                </div>
                            </div>

                            <div className="mb-4">
                                <div className="flex flex-wrap gap-1.5">
                                    {['正常糖', '半糖', '微糖', '無糖', '無法調整'].map(l => (
                                        <button key={l} onClick={() => up(i, 'sugar', l)} className={`px-3 py-1.5 text-[9px] font-bold rounded-xl border ${d.sugar === l ? 'bg-[#F3E5F5] text-[#A696AF] border-[#F3E5F5]' : 'bg-white border-[#F8F2FC]'}`}>{l}</button>
                                    ))}
                                </div>
                            </div>

                            <label className="flex items-center gap-2 cursor-pointer p-3 bg-white/60 rounded-xl border border-white">
                                <input type="checkbox" className="w-4 h-4 accent-[#E5A7AF]" checked={d.continueTomorrow} onChange={e => up(i, 'continueTomorrow', e.target.checked)} /> 
                                <span className="text-[10px] font-bold text-[#94849A]">明天繼續喝 (藍點紀錄)</span>
                            </label>
                        </div>
                    ))}
                    
                    {drinks.length < 3 && (
                        <button onClick={add} className="w-full py-6 border-4 border-dashed border-[#F8F2FC] rounded-3xl text-[#D1C4D4] font-black text-sm hover:bg-[#FAF7FD] transition-all">+ NEW DRINK</button>
                    )}
                    
                    <button onClick={() => onSave(drinks)} className="w-full py-4 bg-[#FDE2E4] text-[#C19EA3] rounded-2xl font-black text-lg shadow-lg active:scale-95 transition-transform">儲存</button>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
